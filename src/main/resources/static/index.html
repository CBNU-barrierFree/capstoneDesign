<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>자전거 사고 다발지역</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
        header {background:#0a4d9e; color:#fff; padding:16px 20px; font-size:22px; font-weight:700;}
        .toolbar {display:flex; gap:8px; padding:10px 12px; align-items:center; border-bottom:1px solid #eee;}
        .toolbar select, .toolbar input, .toolbar button {padding:6px 8px; font-size:14px;}
        .status {padding:8px 12px; color:#c00; min-height:22px;}
        #map {width:100%; height:70vh;}
        .list {padding:10px 12px;}
        .item {padding:6px 0; border-bottom:1px dashed #ddd; font-size:14px;}
        .ok {color:#0a7c2f}
        .muted {color:#666}
    </style>
    <!-- Kakao 지도 SDK (본인 JS키로 교체) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ec7a521b62d776eb9f9d4089423e63da&libraries=clusterer"></script>
</head>
<body>
<header>🚴‍♀️ 자전거 사고 다발지역</header>

<div class="toolbar">
    <label>연도
        <select id="year">
            <option value="">전체</option>
            <!-- 필요 연도만 추가 -->
            <option>2025</option>
            <option>2024</option>
            <option>2023</option>
            <option>2022</option>
            <option selected>2021</option>
            <option>2020</option>
            <option>2019</option>
            <option>2018</option>
            <option>2017</option>
        </select>
    </label>
    <label>정렬
        <select id="order">
            <option value="accidents" selected>사고건수</option>
            <option value="casualties">사상자수</option>
        </select>
    </label>
    <label>표시개수
        <input id="limit" type="number" value="200" min="1" max="500" style="width:80px" />
    </label>
    <button id="btn-refresh">불러오기</button>
    <span id="ping" class="muted"></span>
</div>

<div class="status" id="status"></div>
<div id="map"></div>
<div class="list" id="list"></div>

<script>
    // --- 지도 초기화 (서울 시청 근처) ---
    let map, markers = [];
    function initMap() {
      const container = document.getElementById('map');
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      map = new kakao.maps.Map(container, { center, level: 7 });
    }

    // --- 지도 영역 → BBOX(w,s,e,n) ---
    function currentBBox() {
      const b = map.getBounds();
      const sw = b.getSouthWest(), ne = b.getNorthEast();
      const west = sw.getLng(), south = sw.getLat(), east = ne.getLng(), north = ne.getLat();
      return `${west},${south},${east},${north}`;
    }

    // --- 마커/리스트 렌더 ---
    function clearMarkers() { markers.forEach(m => m.setMap(null)); markers = []; }
    function render(data) {
      clearMarkers();
      const listEl = document.getElementById('list');
      listEl.innerHTML = '';
      if (!data || !Array.isArray(data.items)) return;

      data.items.forEach(row => {
        const marker = new kakao.maps.Marker({
          map, position: new kakao.maps.LatLng(row.lat, row.lng)
        });
        markers.push(marker);

        const div = document.createElement('div');
        div.className = 'item';
        div.textContent =
          `[${row.year ?? '-'}] ${row.name}  ·  사고 ${row.accidents}  ·  사상자 ${row.casualties}`;
        listEl.appendChild(div);
      });
    }

    // --- 안전한 fetch(JSON 강제) ---
    async function fetchJSON(url) {
      const res = await fetch(url, {headers: {Accept: 'application/json'}});
      const text = await res.text();                     // 우선 text로 받고
      if (!res.ok) throw new Error(`HTTP ${res.status} ${text.slice(0, 160)}`);
      // 서버가 실수로 HTML을 보내면 JSON 파싱 전에 차단
      if (text.trim().startsWith('<')) {
        throw new Error('서버가 HTML을 반환했습니다. (JSON 아님)\n' + text.slice(0, 200));
      }
      try {
        return JSON.parse(text);
      } catch (e) {
        throw new Error('JSON 파싱 실패: ' + e.message + '\n미리보기: ' + text.slice(0, 200));
      }
    }

    // --- API 호출 ---
    async function refresh() {
      const status = document.getElementById('status');
      status.textContent = '불러오는 중…';
      const bbox = currentBBox();
      const year = document.getElementById('year').value.trim();   // "" = 전체
      const order = document.getElementById('order').value;
      const limit = document.getElementById('limit').value || '200';

      const params = new URLSearchParams();
      params.set('bbox', bbox);
      params.set('order', order);
      params.set('limit', limit);
      if (year !== '') params.set('year', year); // ✅ “전체”일 때는 year 파라미터를 아예 제외

      const url = '/api/accident-hotspots?' + params.toString();

      try {
        const data = await fetchJSON(url);
        status.innerHTML = `<span class="ok">총 ${data.total}건</span>`;
        render(data);
      } catch (err) {
        console.error(err);
        status.textContent = '데이터 로드 실패: ' + err.message;
        clearMarkers();
        document.getElementById('list').innerHTML = '';
      }
    }

    // --- 서버 연결 확인(ping) ---
    async function ping() {
      try {
        const r = await fetch('/api/accident-hotspots/ping');
        if (r.ok) document.getElementById('ping').textContent = '서버 연결 OK';
        else document.getElementById('ping').textContent = '서버 연결 실패';
      } catch {
        document.getElementById('ping').textContent = '서버 연결 실패';
      }
    }

    // --- 이벤트 바인딩 ---
    window.addEventListener('load', () => {
      initMap();
      ping();
      document.getElementById('btn-refresh').addEventListener('click', refresh);
      // 지도 이동 후 잠깐 멈추면 자동 새로고침 (원하면 주석 해제)
      // kakao.maps.event.addListener(map, 'idle', () => { refresh(); });
      // 최초 1회
      refresh();
    });
</script>
</body>
</html>