<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ê´‘ì§€ ë°°ë¦¬ì–´í”„ë¦¬ ì •ë³´</title>
    <style>
        #places {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
          gap: 16px;
          margin-top: 16px;
        }
        .place {
          background: #fff;
          padding: 16px;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          cursor: pointer;
          position: relative;
        }
        .place:hover {
          background: #f0f8ff;
        }
        .favorite {
          position: absolute;
          top: 12px;
          right: 12px;
          font-size: 20px;
          cursor: pointer;
        }
        .favorite.active {
          color: gold;
        }
        #map {
          width: 100%;
          height: 400px;
          margin: 20px 0;
        }
        .filters {
          display: flex;
          flex-wrap: wrap;
          gap: 16px;
          margin-top: 10px;
        }
        .filters label {
          white-space: nowrap;
        }
        .pagination {
          margin-top: 20px;
          text-align: center;
          grid-column: 1 / -1;
        }
        .pagination button {
          margin: 4px;
          padding: 6px 12px;
          cursor: pointer;
        }
        .pagination button:disabled {
          font-weight: bold;
          background: #eee;
        }
    </style>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ec7a521b62d776eb9f9d4089423e63da&libraries=clusterer"></script>
</head>
<body>

<h1>ğŸ¨ ê´€ê´‘ì§€ ë°°ë¦¬ì–´í”„ë¦¬ ì •ë³´</h1>

<input type="text" id="searchInput" placeholder="ê´€ê´‘ì§€ëª… ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰"
       style="width: 300px; padding: 8px; font-size: 16px;">

<div class="filters">
    <label><input type="checkbox" class="barrier-filter" value="íœ ì²´ì–´ ëŒ€ì—¬ ê°€ëŠ¥"> íœ ì²´ì–´ ëŒ€ì—¬ ê°€ëŠ¥</label>
    <label><input type="checkbox" class="barrier-filter" value="ì¥ì• ì¸ í™”ì¥ì‹¤ ìˆìŒ"> ì¥ì• ì¸ í™”ì¥ì‹¤ ìˆìŒ</label>
    <label><input type="checkbox" class="barrier-filter" value="ì¥ì• ì¸ ì£¼ì°¨êµ¬ì—­ ìˆìŒ"> ì¥ì• ì¸ ì£¼ì°¨êµ¬ì—­ ìˆìŒ</label>
    <label><input type="checkbox" class="barrier-filter" value="ì‹œê°ì¥ì• ì¸ ì•ˆë‚´ê²¬ ë™ë°˜ ê°€ëŠ¥"> ì•ˆë‚´ê²¬ ë™ë°˜ ê°€ëŠ¥</label>
    <label><input type="checkbox" class="barrier-filter" value="ì¥ì• ì¸ ì•ˆë‚´ ì ì ìˆìŒ"> ì ì ì•ˆë‚´ ìˆìŒ</label>
    <label><input type="checkbox" class="barrier-filter" value="ì˜¤ë””ì˜¤ ê°€ì´ë“œ ìˆìŒ(í•œêµ­ì–´)"> ì˜¤ë””ì˜¤ ê°€ì´ë“œ</label>
    <label><input type="checkbox" id="favoriteOnly"> âœ¨ ì¦ê²¨ì°¾ê¸°ë§Œ ë³´ê¸°</label>
</div>

<div id="map"></div>
<div id="places">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<script>
    let allPlaces = [];
    let filteredPlaces = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let map, clusterer;
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

    function toggleFavorite(title) {
      const index = favorites.indexOf(title);
      if (index > -1) favorites.splice(index, 1);
      else favorites.push(title);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      filterPlaces();
    }

    function initMap() {
      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 7
      };
      map = new kakao.maps.Map(container, options);
      clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter: true, minLevel: 5 });

      kakao.maps.event.addListener(map, 'idle', filterPlaces); // âœ… ì§€ë„ ì´ë™ í›„ í•„í„°ë§ ì ìš©
    }

    function addAllMarkers(places) {
      clusterer.clear();
      const markerList = [];
      places.forEach(place => {
        const match = place.coordinates?.match(/N([\d.]+), E([\d.]+)/);
        if (match) {
          const lat = parseFloat(match[1]);
          const lng = parseFloat(match[2]);
          const latlng = new kakao.maps.LatLng(lat, lng);
          const marker = new kakao.maps.Marker({ position: latlng, title: place.title });
          const infowindow = new kakao.maps.InfoWindow({ content: `<div style='padding:8px;font-size:14px;'><strong>${place.title}</strong></div>` });
          kakao.maps.event.addListener(marker, 'mouseover', () => infowindow.open(map, marker));
          kakao.maps.event.addListener(marker, 'mouseout', () => infowindow.close());
          markerList.push(marker);
        }
      });
      clusterer.addMarkers(markerList);
    }

    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const pagination = document.createElement('div');
      pagination.className = 'pagination';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.disabled = true;
        btn.addEventListener('click', () => {
          currentPage = i;
          renderPlaces(filteredPlaces);
        });
        pagination.appendChild(btn);
      }
      document.getElementById('places').appendChild(pagination);
    }

    function renderPlaces(places) {
      const container = document.getElementById('places');
      container.innerHTML = '';
      const start = (currentPage - 1) * itemsPerPage;
      const pageItems = places.slice(start, start + itemsPerPage);

      pageItems.forEach(place => {
        const div = document.createElement('div');
        div.className = 'place';
        const isFav = favorites.includes(place.title);

        div.innerHTML = `
          <div class="favorite ${isFav ? 'active' : ''}" onclick="toggleFavorite('${place.title}')">
            ${isFav ? 'â˜…' : 'â˜†'}
          </div>
          <h2>${place.title}</h2>
          <p><strong>ğŸ“ ì£¼ì†Œ:</strong> ${place.address}</p>
          <p><strong>ğŸ•’ ìš´ì˜ì‹œê°„:</strong> ${place.description}</p>
          <p><strong>ğŸ“… ë“±ë¡ì¼:</strong> ${place.issuedDate}</p>
          <p><strong>ğŸ“ ì—°ë½ì²˜:</strong> ${place.tel || 'ì •ë³´ ì—†ìŒ'}</p>
          <p><strong>ğŸŒ í™ˆí˜ì´ì§€:</strong> ${place.url ? `<a href='http://${place.url}' target='_blank'>${place.url}</a>` : 'ì •ë³´ ì—†ìŒ'}</p>
          <p><strong>ğŸ“ ì¹´í…Œê³ ë¦¬:</strong> ${place.category1} / ${place.category2}</p>
          <p><strong>â™¿ ë°°ë¦¬ì–´í”„ë¦¬ ì •ë³´:</strong> ${place.subDescription}</p>
          <p><strong>ğŸ“Œ ì¢Œí‘œ:</strong> ${place.coordinates}</p>
        `;
        container.appendChild(div);
      });

      renderPagination(places.length);
      addAllMarkers(places);
    }

    function filterPlaces() {
      const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
      const checkedFilters = Array.from(document.querySelectorAll('.barrier-filter:checked')).map(cb => cb.value);
      const favoriteOnly = document.getElementById('favoriteOnly').checked;

      const bounds = map.getBounds();

      filteredPlaces = allPlaces.filter(place => {
        const titleMatch = place.title.toLowerCase().includes(keyword);
        const addressMatch = place.address.toLowerCase().includes(keyword);
        const sub = place.subDescription || '';
        const filtersPass = checkedFilters.every(term => sub.includes(term));
        const favoritePass = !favoriteOnly || favorites.includes(place.title);

        const match = place.coordinates?.match(/N([\d.]+), E([\d.]+)/);
        let inMapBounds = true;
        if (match) {
          const latlng = new kakao.maps.LatLng(parseFloat(match[1]), parseFloat(match[2]));
          inMapBounds = bounds.contain(latlng);
        }

        return (titleMatch || addressMatch) && filtersPass && favoritePass && inMapBounds;
      });

      currentPage = 1;
      renderPlaces(filteredPlaces);
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('searchInput').addEventListener('input', filterPlaces);
      document.querySelectorAll('.barrier-filter').forEach(cb => cb.addEventListener('change', filterPlaces));
      document.getElementById('favoriteOnly').addEventListener('change', filterPlaces);
    });

    initMap();
    fetch('/api/tour')
      .then(res => res.json())
      .then(data => {
        allPlaces = data?.response?.body?.items?.item || [];
        filteredPlaces = allPlaces;
        renderPlaces(filteredPlaces);
      })
      .catch(error => {
        console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
        document.getElementById('places').innerHTML = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      });
</script>

</body>
</html>
