<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ê´‘ì§€ ë°°ë¦¬ì–´í”„ë¦¬ ì •ë³´</title>
    <style>
        .place {
          background: #fff;
          padding: 16px;
          margin: 10px 0;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #map {
          width: 100%;
          height: 400px;
          margin: 20px 0;
        }
    </style>

    <!-- âœ… ì¹´ì¹´ì˜¤ ì§€ë„ API ë¶ˆëŸ¬ì˜¤ê¸° (ìˆœì„œ ì¤‘ìš”, autoload X) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ec7a521b62d776eb9f9d4089423e63da"></script>
</head>
<body>

<h1>ğŸ¨ ê´€ê´‘ì§€ ë°°ë¦¬ì–´í”„ë¦¬ ì •ë³´</h1>

<!-- ğŸ” ê²€ìƒ‰ì°½ -->
<input type="text" id="searchInput" placeholder="ê´€ê´‘ì§€ëª… ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰"
       style="width: 300px; padding: 8px; font-size: 16px;">
<button onclick="filterPlaces()">ê²€ìƒ‰</button>

<!-- ğŸ—ºï¸ ì§€ë„ ì˜ì—­ -->
<div id="map"></div>

<!-- ğŸ“„ ê´€ê´‘ì§€ ë¦¬ìŠ¤íŠ¸ -->
<div id="places">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<script>
    let allPlaces = [];
    let map;
    let markers = [];

    // âœ… ì§€ë„ ì´ˆê¸°í™”
    function initMap() {
      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì¤‘ì‹¬
        level: 7
      };
      map = new kakao.maps.Map(container, options);
    }

    // âœ… ë§ˆì»¤ ì¶”ê°€
    function addMarker(lat, lng, title) {
      const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        map: map,
        title: title
      });
      markers.push(marker);
    }

    // âœ… ê¸°ì¡´ ë§ˆì»¤ ì œê±°
    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }

    // âœ… ê´€ê´‘ì§€ ì¶œë ¥ í•¨ìˆ˜
    function renderPlaces(places) {
      const container = document.getElementById('places');
      container.innerHTML = '';
      clearMarkers();

      if (!places || places.length === 0) {
        container.innerHTML = 'ê´€ê´‘ì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      places.forEach(place => {
        const div = document.createElement('div');
        div.className = 'place';

        div.innerHTML = `
          <h2>${place.title}</h2>
          <p><strong>ğŸ“ ì£¼ì†Œ:</strong> ${place.address}</p>
          <p><strong>ğŸ•’ ìš´ì˜ì‹œê°„:</strong> ${place.description}</p>
          <p><strong>ğŸ“… ë“±ë¡ì¼:</strong> ${place.issuedDate}</p>
          <p><strong>ğŸ“ ì—°ë½ì²˜:</strong> ${place.tel || 'ì •ë³´ ì—†ìŒ'}</p>
          <p><strong>ğŸŒ í™ˆí˜ì´ì§€:</strong> ${
            place.url ? `<a href="http://${place.url}" target="_blank">${place.url}</a>` : 'ì •ë³´ ì—†ìŒ'
          }</p>
          <p><strong>ğŸ“ ì¹´í…Œê³ ë¦¬:</strong> ${place.category1} / ${place.category2}</p>
          <p><strong>â™¿ ë°°ë¦¬ì–´í”„ë¦¬ ì •ë³´:</strong> ${place.subDescription}</p>
          <p><strong>ğŸ“Œ ì¢Œí‘œ:</strong> ${place.coordinates}</p>
        `;
        container.appendChild(div);

        // ì¢Œí‘œ ì¶”ì¶œí•´ì„œ ë§ˆì»¤ ì¶”ê°€
        const coordText = place.coordinates;
        const match = coordText?.match(/N([\d.]+), E([\d.]+)/);
        if (match) {
          const lat = parseFloat(match[1]);
          const lng = parseFloat(match[2]);
          addMarker(lat, lng, place.title);
        }
      });
    }

    // âœ… ê²€ìƒ‰ ê¸°ëŠ¥
    function filterPlaces() {
      const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
      const filtered = allPlaces.filter(place =>
        place.title.toLowerCase().includes(keyword) ||
        place.address.toLowerCase().includes(keyword)
      );
      renderPlaces(filtered);
    }

    // âœ… ì‹¤í–‰ ì‹œì‘
    initMap(); // ì§€ë„ ë¨¼ì € ìƒì„±

    fetch('/api/tour') // ë°±ì—”ë“œì—ì„œ JSON ë°ì´í„° ë°›ì•„ì˜¤ê¸°
      .then(res => res.json())
      .then(data => {
        allPlaces = data?.response?.body?.items?.item || [];
        renderPlaces(allPlaces);
      })
      .catch(error => {
        console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
        document.getElementById('places').innerHTML = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      });
</script>

</body>
</html>
