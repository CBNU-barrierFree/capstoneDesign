<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê´€ê´‘ì§€ ë°°ë¦¬ì–´í”„ë¦¬ ì •ë³´</title>
    <style>
        header {
            background: #004080;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-buttons a {
            color: white;
            text-decoration: none;
            margin-left: 16px;
            font-weight: bold;
        }
        .nav-buttons a:hover {
            text-decoration: underline;
        }


        #places {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .place {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
        }
        .place:hover {
            background: #f0f8ff;
        }
        .favorite {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 20px;
            cursor: pointer;
        }
        .favorite.active {
            color: gold;
        }
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 10px;
        }
        .filters label {
            white-space: nowrap;
        }
        .pagination {
            margin-top: 20px;
            text-align: center;
            grid-column: 1 / -1;
        }
        .pagination button {
            margin: 4px;
            padding: 6px 12px;
            cursor: pointer;
        }
        .pagination button:disabled {
            font-weight: bold;
            background: #eee;
        }
        #map {
            width: 100%;
            height: 400px;
            margin: 20px 0;
        }
    </style>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ec7a521b62d776eb9f9d4089423e63da&libraries=clusterer"></script>


</head>
<body>

<header>
    <h1>ğŸ¨ ê´€ê´‘ì§€ ë°°ë¦¬ì–´í”„ë¦¬ ì •ë³´</h1>
    <div class="nav-buttons" id="auth-section">
        <a href="/posts">ğŸ“ ê²Œì‹œíŒ</a>
        <a href="/users/login">ğŸ” ë¡œê·¸ì¸</a>
        <a href="/users/signup">ğŸ“ íšŒì›ê°€ì…</a>
    </div>
</header>

<input type="text" id="searchInput" placeholder="ê´€ê´‘ì§€ëª… ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰"
       style="width: 300px; padding: 8px; font-size: 16px;"> <button id="sortByDistance">ğŸ“ ë‚´ ìœ„ì¹˜ ê¸°ì¤€ ì •ë ¬</button>

<div class="filters">
    <label><input type="checkbox" class="barrier-filter" value="íœ ì²´ì–´ ëŒ€ì—¬ ê°€ëŠ¥"> íœ ì²´ì–´ ëŒ€ì—¬ ê°€ëŠ¥</label>
    <label><input type="checkbox" class="barrier-filter" value="ì¥ì• ì¸ í™”ì¥ì‹¤ ìˆìŒ"> ì¥ì• ì¸ í™”ì¥ì‹¤ ìˆìŒ</label>
    <label><input type="checkbox" class="barrier-filter" value="ì¥ì• ì¸ ì£¼ì°¨êµ¬ì—­ ìˆìŒ"> ì¥ì• ì¸ ì£¼ì°¨êµ¬ì—­ ìˆìŒ</label>
    <label><input type="checkbox" class="barrier-filter" value="ì‹œê°ì¥ì• ì¸ ì•ˆë‚´ê²¬ ë™ë°˜ ê°€ëŠ¥"> ì•ˆë‚´ê²¬ ë™ë°˜ ê°€ëŠ¥</label>
    <label><input type="checkbox" class="barrier-filter" value="ì¥ì• ì¸ ì•ˆë‚´ ì ì ìˆìŒ"> ì ì ì•ˆë‚´ ìˆìŒ</label>
    <label><input type="checkbox" class="barrier-filter" value="ì˜¤ë””ì˜¤ ê°€ì´ë“œ ìˆìŒ(í•œêµ­ì–´)"> ì˜¤ë””ì˜¤ ê°€ì´ë“œ</label>
</div>

<div id="map"></div>
<div id="places">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<script>
    let allPlaces = [];
    let filteredPlaces = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let map, clusterer, myMarker = null;
    let myLat = null, myLng = null;
    let allMarkers = [];
    let selectedInfowindow = null; // í˜„ì¬ ì—´ë¦° ë§í’ì„ 

    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

    function initMap() {
        const container = document.getElementById('map');
        map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 7 });
        clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter: true, minLevel: 5 });
        kakao.maps.event.addListener(map, 'idle', filterPlaces);
    }

    function addAllMarkers(places) {
        clusterer.clear();
        allMarkers = [];

        places.forEach(place => {
            const match = place.coordinates?.match(/N([\d.]+), E([\d.]+)/);
            if (match) {
                const latlng = new kakao.maps.LatLng(parseFloat(match[1]), parseFloat(match[2]));
                const marker = new kakao.maps.Marker({ position: latlng, title: place.title });
                const infowindow = new kakao.maps.InfoWindow({ content: `<div style='padding:8px;font-size:14px;'><strong>${place.title}</strong></div>` });

                // ë§ˆì»¤ í´ë¦­
                kakao.maps.event.addListener(marker, 'click', () => {
                    if (selectedInfowindow) selectedInfowindow.close();
                    infowindow.open(map, marker);
                    selectedInfowindow = infowindow;
                    map.setCenter(marker.getPosition());
                });

                // ë§ˆìš°ìŠ¤ ì˜¤ë²„ (ì„ íƒëœ ê²Œ ì•„ë‹ ë•Œë§Œ ì—´ê¸°)
                kakao.maps.event.addListener(marker, 'mouseover', () => {
                    if (selectedInfowindow !== infowindow) infowindow.open(map, marker);
                });

                kakao.maps.event.addListener(marker, 'mouseout', () => {
                    if (selectedInfowindow !== infowindow) infowindow.close();
                });

                allMarkers.push({ marker, infowindow, title: place.title });
            }
        });

        clusterer.addMarkers(allMarkers.map(m => m.marker));
    }

    function renderPlaces(places) {
        const container = document.getElementById('places');
        container.innerHTML = '';
        const start = (currentPage - 1) * itemsPerPage;
        const pageItems = places.slice(start, start + itemsPerPage);

        pageItems.forEach(place => {
            const div = document.createElement('div');
            div.className = 'place';
            const isFav = favorites.includes(place.title);

            div.innerHTML = `
              <h2>${place.title}</h2>
              <p><strong>ğŸ“ ì£¼ì†Œ:</strong> ${place.address}</p>
              <p><strong>ğŸ•’ ìš´ì˜ì‹œê°„:</strong> ${place.description}</p>
              <p><strong>ğŸ“… ë“±ë¡ì¼:</strong> ${place.issuedDate}</p>
              <p><strong>ğŸ“ ì—°ë½ì²˜:</strong> ${place.tel || 'ì •ë³´ ì—†ìŒ'}</p>
              <p><strong>ğŸŒ í™ˆí˜ì´ì§€:</strong> ${place.url ? `<a href='http://${place.url}' target='_blank'>${place.url}</a>` : 'ì •ë³´ ì—†ìŒ'}</p>
              <p><strong>ğŸ“ ì¹´í…Œê³ ë¦¬:</strong> ${place.category1} / ${place.category2}</p>
              <p><strong>â™¿ ë°°ë¦¬ì–´í”„ë¦¬ ì •ë³´:</strong> ${place.subDescription}</p>
              <p><strong>ğŸ“Œ ì¢Œí‘œ:</strong> ${place.coordinates}</p>
            `;

            // ëª©ë¡ í´ë¦­ ì‹œ í•´ë‹¹ ë§ˆì»¤ë¡œ ì´ë™ + ë§í’ì„  ê´€ë¦¬
            div.addEventListener('click', () => {
                const markerObj = allMarkers.find(m => m.title === place.title);
                if (markerObj) {
                    if (selectedInfowindow) selectedInfowindow.close();
                    markerObj.infowindow.open(map, markerObj.marker);
                    selectedInfowindow = markerObj.infowindow;
                    map.setCenter(markerObj.marker.getPosition());
                }
            });

            container.appendChild(div);
        });

        renderPagination(places.length);
        addAllMarkers(places);
    }

    function renderPagination(totalItems) {
        const container = document.createElement('div');
        container.className = 'pagination';

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const pageGroupSize = 10;
        const currentGroup = Math.floor((currentPage - 1) / pageGroupSize);

        const startPage = currentGroup * pageGroupSize + 1;
        const endPage = Math.min(startPage + pageGroupSize - 1, totalPages);

        if (startPage > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'â—€';
            prevBtn.addEventListener('click', () => {
                currentPage = startPage - 1;
                renderPlaces(filteredPlaces);
            });
            container.appendChild(prevBtn);
        }

        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            if (i === currentPage) btn.disabled = true;
            btn.addEventListener('click', () => {
                currentPage = i;
                renderPlaces(filteredPlaces);
            });
            container.appendChild(btn);
        }

        if (endPage < totalPages) {
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'â–¶';
            nextBtn.addEventListener('click', () => {
                currentPage = endPage + 1;
                renderPlaces(filteredPlaces);
            });
            container.appendChild(nextBtn);
        }

        document.getElementById('places').appendChild(container);
    }

    function filterPlaces() {
        const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
        const checkedFilters = Array.from(document.querySelectorAll('.barrier-filter:checked')).map(cb => cb.value);
        const favoriteOnly = document.getElementById('favoriteOnly')?.checked || false;
        const bounds = map.getBounds();

        filteredPlaces = allPlaces.filter(place => {
            const titleMatch = place.title.toLowerCase().includes(keyword);
            const addressMatch = place.address.toLowerCase().includes(keyword);
            const sub = place.subDescription || '';
            const filtersPass = checkedFilters.every(term => sub.includes(term));
            const favoritePass = !favoriteOnly || favorites.includes(place.title);

            const match = place.coordinates?.match(/N([\d.]+), E([\d.]+)/);
            let inMapBounds = true;
            if (match) {
                const latlng = new kakao.maps.LatLng(parseFloat(match[1]), parseFloat(match[2]));
                inMapBounds = bounds.contain(latlng);
            }

            return (titleMatch || addressMatch) && filtersPass && favoritePass && inMapBounds;
        });

        currentPage = 1;
        renderPlaces(filteredPlaces);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const toRad = x => x * Math.PI / 180;
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function sortByMyLocation() {
        if (!navigator.geolocation) {
            alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
            return;
        }
        navigator.geolocation.getCurrentPosition(position => {
            myLat = position.coords.latitude;
            myLng = position.coords.longitude;

            const currentLocation = new kakao.maps.LatLng(myLat, myLng);
            map.setCenter(currentLocation);

            if (myMarker) myMarker.setMap(null);
            myMarker = new kakao.maps.Marker({
                position: currentLocation,
                map: map,
                title: 'í˜„ì¬ ë‚´ ìœ„ì¹˜',
                image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png', new kakao.maps.Size(40, 42))
            });

            filteredPlaces.sort((a, b) => {
                const aMatch = a.coordinates?.match(/N([\d.]+), E([\d.]+)/);
                const bMatch = b.coordinates?.match(/N([\d.]+), E([\d.]+)/);
                if (!aMatch || !bMatch) return 0;
                const aDist = getDistance(myLat, myLng, parseFloat(aMatch[1]), parseFloat(aMatch[2]));
                const bDist = getDistance(myLat, myLng, parseFloat(bMatch[1]), parseFloat(bMatch[2]));
                return aDist - bDist;
            });

            currentPage = 1;
            renderPlaces(filteredPlaces);
        }, () => {
            alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        });
    }

    document.getElementById('sortByDistance')?.addEventListener('click', sortByMyLocation);
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('searchInput').addEventListener('input', filterPlaces);
        document.querySelectorAll('.barrier-filter').forEach(cb => cb.addEventListener('change', filterPlaces));
        document.getElementById('favoriteOnly')?.addEventListener('change', filterPlaces);

        const cookies = document.cookie.split(';').map(c => c.trim());
        const nicknameCookie = cookies.find(c => c.startsWith('nickname='));
        const authSection = document.getElementById('auth-section');

        if (nicknameCookie && authSection) {
            const nickname = decodeURIComponent(nicknameCookie.split('=')[1]);
            authSection.innerHTML = `
            <a href="/posts">ğŸ“ ê²Œì‹œíŒ</a>
            <span><strong>${nickname}</strong> ë‹˜</span>
            <a href="/users/logout">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
        `;
        }
    });

    initMap();
    fetch('/api/tour')
        .then(res => res.json())
        .then(data => {
            allPlaces = data?.response?.body?.items?.item || [];
            filteredPlaces = allPlaces;
            renderPlaces(filteredPlaces);
        })
        .catch(error => {
            console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
            document.getElementById('places').innerHTML = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        });
</script>

</body>
</html>