<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ìì „ê±° ì‚¬ê³  ë‹¤ë°œì§€ì—­</title>
    <style>
        body { margin:0; font-family: Arial, sans-serif; }
        header {
          background:#004080; color:#fff; padding:12px 20px;
          display:flex; justify-content:space-between; align-items:center;
        }
        .nav-buttons { display:flex; align-items:center; gap:16px; }
        .nav-buttons a { color:#fff; text-decoration:none; font-weight:bold; }
        .nav-buttons a:hover { text-decoration:underline; }

        .toolbar {
          display:flex; gap:12px; flex-wrap:wrap; align-items:center;
          padding:12px 20px; border-bottom:1px solid #eee;
        }
        .toolbar select { padding:6px 8px; }
        .badge { font-size:12px; color:#666; margin-left:8px; }

        #map { width:100%; height:420px; margin: 10px 0 0; }
        #places {
          display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr));
          gap:16px; padding:16px 20px;
        }
        .place {
          background:#fff; padding:14px; border-radius:8px;
          box-shadow:0 2px 4px rgba(0,0,0,0.08); cursor:pointer;
        }
        .place:hover { background:#f7fbff; }
        .pagination { grid-column:1/-1; text-align:center; }
        .pagination button { margin:4px; padding:6px 12px; cursor:pointer; }
        .pagination button:disabled { background:#eee; font-weight:bold; }
    </style>
    <!-- Kakao Maps SDK -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ec7a521b62d776eb9f9d4089423e63da&libraries=clusterer"></script>
</head>

<body>
<header>
    <h1>ğŸš² ìì „ê±° ì‚¬ê³  ë‹¤ë°œì§€ì—­</h1>
    <div class="nav-buttons" id="auth-section">
        <a href="/posts">ğŸ“ ê²Œì‹œíŒ</a>
        <a href="/users/login">ğŸ” ë¡œê·¸ì¸</a>
        <a href="/users/signup">ğŸ§¾ íšŒì›ê°€ì…</a>
    </div>
</header>

<div class="toolbar">
    <label>ì—°ë„
        <select id="year" required>
            <!-- âœ… 'ì „ì²´' ì œê±°, ê¸°ë³¸ 2023 ì„ íƒ -->
            <option value="2023" selected>2023</option>
            <option value="2024">2024</option>
            <!-- í•„ìš”í•˜ë©´ ë” ì¶”ê°€ -->
        </select>
    </label>
    <label>ì •ë ¬
        <select id="order">
            <option value="accidents">ì‚¬ê³ ê±´ìˆ˜</option>
            <option value="casualties">ì‚¬ìƒììˆ˜</option>
        </select>
    </label>
    <span class="badge" id="status">í˜„ì¬ ë²”ìœ„: 0ê°œ</span>
</div>

<div id="map"></div>
<div id="places">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>

<script>
    // ----------------- ìƒíƒœ -----------------
    let map, clusterer;
    let allItems = [];
    let markers = [];
    let infoWindows = [];
    let selectedInfo = null;
    let inFlight;               // AbortController
    let page = 1;
    const pageSize = 12;

    // ----------------- ìœ í‹¸ -----------------
    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }

    function getBBoxParam() {
      const b = map.getBounds(), sw=b.getSouthWest(), ne=b.getNorthEast();
      return `${sw.getLng()},${sw.getLat()},${ne.getLng()},${ne.getLat()}`; // west,south,east,north
    }

    async function apiGet(url){
      if (inFlight) inFlight.abort();
      inFlight = new AbortController();
      const r = await fetch(url, {
        signal: inFlight.signal,
        headers: { "Accept": "application/json" } // âœ… JSONìœ¼ë¡œë§Œ ì‘ë‹µ ë°›ê¸°
      });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    // ----------------- ë Œë” -----------------
    function render() {
      // ì§€ë„ ë§ˆì»¤ ì´ˆê¸°í™”
      clusterer.clear();
      markers.forEach(m => m.setMap(null));
      infoWindows.forEach(iw => iw.close());
      markers = [];
      infoWindows = [];
      selectedInfo = null;

      allItems.forEach((it, idx) => {
        const pos = new kakao.maps.LatLng(it.lat, it.lng);
        const m = new kakao.maps.Marker({ position: pos, title: it.name });
        const iw = new kakao.maps.InfoWindow({
          content: `<div style="padding:6px 8px;font-size:13px">
                      <b>${it.name||'(ë¬´ëª… ì§€ì )'}</b><br/>
                      ì‚¬ê³  ${it.accidents}ê±´ Â· ì‚¬ìƒì ${it.casualties}ëª…<br/>
                      ${it.year ? `ì—°ë„ ${it.year}` : ''}
                    </div>`
        });
        kakao.maps.event.addListener(m, 'click', () => {
          if (selectedInfo) selectedInfo.close();
          iw.open(map, m);
          selectedInfo = iw;
          map.panTo(m.getPosition());
        });
        kakao.maps.event.addListener(m, 'mouseover', () => { if (selectedInfo!==iw) iw.open(map, m); });
        kakao.maps.event.addListener(m, 'mouseout',  () => { if (selectedInfo!==iw) iw.close(); });

        markers.push(m);
        infoWindows.push(iw);
      });
      clusterer.addMarkers(markers);

      renderList();
    }

    function renderList(){
      const container = document.getElementById('places');
      const total = allItems.length;
      if (total === 0) {
        container.innerHTML = `<div style="color:#666">í˜„ì¬ ë²”ìœ„ì— ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ ì´ë™í•˜ê±°ë‚˜ í•„í„°ë¥¼ ë³€ê²½í•´ë³´ì„¸ìš”.</div>`;
        return;
      }
      const start = (page-1)*pageSize;
      const items = allItems.slice(start, start+pageSize);

      container.innerHTML = items.map(it => `
        <div class="place" data-id="${it.id}">
          <h2>${it.name}</h2>
          <p>ì‚¬ê³  ${it.accidents}ê±´ Â· ì‚¬ìƒì ${it.casualties}ëª… ${it.year ? `Â· ${it.year}ë…„` : ''}</p>
          <p style="color:#666">(${it.lat.toFixed(5)}, ${it.lng.toFixed(5)})</p>
        </div>
      `).join('') + pagination(total);

      // ì¹´ë“œ í´ë¦­ â†’ í•´ë‹¹ ë§ˆì»¤ í¬ì»¤ìŠ¤
      document.querySelectorAll('.place').forEach((el, i) => {
        el.addEventListener('click', () => {
          const idx = start + i;
          const m = markers[idx], iw = infoWindows[idx];
          if (!m) return;
          if (selectedInfo) selectedInfo.close();
          iw.open(map, m);
          selectedInfo = iw;
          map.panTo(m.getPosition());
        });
      });

      // í˜ì´ì§€ ë²„íŠ¼
      document.querySelectorAll('.pagination button[data-p]').forEach(btn=>{
        btn.addEventListener('click', () => { page = Number(btn.dataset.p); renderList(); });
      });
    }

    function pagination(total){
      const pages = Math.ceil(total/pageSize);
      if (pages <= 1) return '';
      let html = `<div class="pagination">`;
      if (page>1) html += `<button data-p="${page-1}">â—€</button>`;
      for(let p=1;p<=pages;p++){
        html += `<button ${p===page?'disabled':''} data-p="${p}">${p}</button>`;
      }
      if (page<pages) html += `<button data-p="${page+1}">â–¶</button>`;
      html += `</div>`;
      return html;
    }

    // ----------------- ë°ì´í„° ê°±ì‹  -----------------
    async function refresh(){
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';

      const year = document.getElementById('year').value;
      if (!year) { statusEl.textContent = 'ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”.'; return; } // ì•ˆì „
      const order = document.getElementById('order').value;

      const qs = new URLSearchParams();
      qs.set('bbox', getBBoxParam());
      qs.set('year', year);              // âœ… í•­ìƒ í¬í•¨
      qs.set('order', order);
      qs.set('limit', '300');

      try{
        const data = await apiGet(`/api/accident-hotspots?${qs.toString()}`);
        allItems = data.items || [];
        page = 1;
        statusEl.textContent = `í˜„ì¬ ë²”ìœ„: ${data.total ?? allItems.length}ê°œ`;
        render();
      }catch(e){
        console.error(e);
        statusEl.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        document.getElementById('places').innerHTML =
          '<div style="color:#c00">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
      }
    }

    // ----------------- ì´ˆê¸°í™” -----------------
    function initAuth(){
      const cookies = document.cookie.split(';').map(c=>c.trim());
      const nick = cookies.find(c=>c.startsWith('nickname='));
      const el = document.getElementById('auth-section');
      if (nick && el) {
        const nickname = decodeURIComponent(nick.split('=')[1]);
        el.innerHTML = `
          <a href="/posts">ğŸ“ ê²Œì‹œíŒ</a>
          <span><strong>${nickname}</strong> ë‹˜</span>
          <a href="/users/logout">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>`;
      }
    }

    function init(){
      initAuth();

      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.5665,126.9780), level: 7
      });
      clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter: true, minLevel: 6 });

      kakao.maps.event.addListener(map, 'idle', debounce(refresh, 250));
      document.getElementById('year').addEventListener('change', refresh);
      document.getElementById('order').addEventListener('change', refresh);

      refresh(); // ìµœì´ˆ í˜¸ì¶œ
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>