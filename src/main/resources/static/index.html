<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>ìì „ê±° ì‚¬ê³  ë‹¤ë°œì§€ì—­</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
        header {background:#0a4d9e; color:#fff; padding:16px 20px; font-size:22px; font-weight:700;}
        .toolbar {display:flex; gap:8px; padding:10px 12px; align-items:center; border-bottom:1px solid #eee;}
        .toolbar select, .toolbar input, .toolbar button {padding:6px 8px; font-size:14px;}
        .status {padding:8px 12px; color:#c00; min-height:22px;}
        #map {width:100%; height:70vh;}
        .list {padding:10px 12px;}
        .item {padding:6px 0; border-bottom:1px dashed #ddd; font-size:14px;}
        .ok {color:#0a7c2f}
        .muted {color:#666}
    </style>
    <!-- Kakao ì§€ë„ SDK (ë³¸ì¸ JSí‚¤ë¡œ êµì²´) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ec7a521b62d776eb9f9d4089423e63da&libraries=clusterer"></script>
</head>
<body>
<header>ğŸš´â€â™€ï¸ ìì „ê±° ì‚¬ê³  ë‹¤ë°œì§€ì—­</header>

<div class="toolbar">
    <label>ì—°ë„
        <select id="year">
            <option value="">ì „ì²´</option>
            <!-- í•„ìš” ì—°ë„ë§Œ ì¶”ê°€ -->
            <option>2025</option>
            <option>2024</option>
            <option>2023</option>
            <option>2022</option>
            <option selected>2021</option>
            <option>2020</option>
            <option>2019</option>
            <option>2018</option>
            <option>2017</option>
        </select>
    </label>
    <label>ì •ë ¬
        <select id="order">
            <option value="accidents" selected>ì‚¬ê³ ê±´ìˆ˜</option>
            <option value="casualties">ì‚¬ìƒììˆ˜</option>
        </select>
    </label>
    <label>í‘œì‹œê°œìˆ˜
        <input id="limit" type="number" value="200" min="1" max="500" style="width:80px" />
    </label>
    <button id="btn-refresh">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <span id="ping" class="muted"></span>
</div>

<div class="status" id="status"></div>
<div id="map"></div>
<div class="list" id="list"></div>

<script>
    // --- ì§€ë„ ì´ˆê¸°í™” (ì„œìš¸ ì‹œì²­ ê·¼ì²˜) ---
    let map, markers = [];
    function initMap() {
      const container = document.getElementById('map');
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      map = new kakao.maps.Map(container, { center, level: 7 });
    }

    // --- ì§€ë„ ì˜ì—­ â†’ BBOX(w,s,e,n) ---
    function currentBBox() {
      const b = map.getBounds();
      const sw = b.getSouthWest(), ne = b.getNorthEast();
      const west = sw.getLng(), south = sw.getLat(), east = ne.getLng(), north = ne.getLat();
      return `${west},${south},${east},${north}`;
    }

    // --- ë§ˆì»¤/ë¦¬ìŠ¤íŠ¸ ë Œë” ---
    function clearMarkers() { markers.forEach(m => m.setMap(null)); markers = []; }
    function render(data) {
      clearMarkers();
      const listEl = document.getElementById('list');
      listEl.innerHTML = '';
      if (!data || !Array.isArray(data.items)) return;

      data.items.forEach(row => {
        const marker = new kakao.maps.Marker({
          map, position: new kakao.maps.LatLng(row.lat, row.lng)
        });
        markers.push(marker);

        const div = document.createElement('div');
        div.className = 'item';
        div.textContent =
          `[${row.year ?? '-'}] ${row.name}  Â·  ì‚¬ê³  ${row.accidents}  Â·  ì‚¬ìƒì ${row.casualties}`;
        listEl.appendChild(div);
      });
    }

    // --- ì•ˆì „í•œ fetch(JSON ê°•ì œ) ---
    async function fetchJSON(url) {
      const res = await fetch(url, {headers: {Accept: 'application/json'}});
      const text = await res.text();                     // ìš°ì„  textë¡œ ë°›ê³ 
      if (!res.ok) throw new Error(`HTTP ${res.status} ${text.slice(0, 160)}`);
      // ì„œë²„ê°€ ì‹¤ìˆ˜ë¡œ HTMLì„ ë³´ë‚´ë©´ JSON íŒŒì‹± ì „ì— ì°¨ë‹¨
      if (text.trim().startsWith('<')) {
        throw new Error('ì„œë²„ê°€ HTMLì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. (JSON ì•„ë‹˜)\n' + text.slice(0, 200));
      }
      try {
        return JSON.parse(text);
      } catch (e) {
        throw new Error('JSON íŒŒì‹± ì‹¤íŒ¨: ' + e.message + '\në¯¸ë¦¬ë³´ê¸°: ' + text.slice(0, 200));
      }
    }

    // --- API í˜¸ì¶œ ---
    async function refresh() {
      const status = document.getElementById('status');
      status.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      const bbox = currentBBox();
      const year = document.getElementById('year').value.trim();   // "" = ì „ì²´
      const order = document.getElementById('order').value;
      const limit = document.getElementById('limit').value || '200';

      const params = new URLSearchParams();
      params.set('bbox', bbox);
      params.set('order', order);
      params.set('limit', limit);
      if (year !== '') params.set('year', year); // âœ… â€œì „ì²´â€ì¼ ë•ŒëŠ” year íŒŒë¼ë¯¸í„°ë¥¼ ì•„ì˜ˆ ì œì™¸

      const url = '/api/accident-hotspots?' + params.toString();

      try {
        const data = await fetchJSON(url);
        status.innerHTML = `<span class="ok">ì´ ${data.total}ê±´</span>`;
        render(data);
      } catch (err) {
        console.error(err);
        status.textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + err.message;
        clearMarkers();
        document.getElementById('list').innerHTML = '';
      }
    }

    // --- ì„œë²„ ì—°ê²° í™•ì¸(ping) ---
    async function ping() {
      try {
        const r = await fetch('/api/accident-hotspots/ping');
        if (r.ok) document.getElementById('ping').textContent = 'ì„œë²„ ì—°ê²° OK';
        else document.getElementById('ping').textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
      } catch {
        document.getElementById('ping').textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
      }
    }

    // --- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
    window.addEventListener('load', () => {
      initMap();
      ping();
      document.getElementById('btn-refresh').addEventListener('click', refresh);
      // ì§€ë„ ì´ë™ í›„ ì ê¹ ë©ˆì¶”ë©´ ìë™ ìƒˆë¡œê³ ì¹¨ (ì›í•˜ë©´ ì£¼ì„ í•´ì œ)
      // kakao.maps.event.addListener(map, 'idle', () => { refresh(); });
      // ìµœì´ˆ 1íšŒ
      refresh();
    });
</script>
</body>
</html>